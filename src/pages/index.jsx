import { useRef, useContext, useMemo, useEffect } from "react";
import Head from "next/head";
import { Canvas, extend } from "@react-three/fiber";
import { OrbitControls, Box, Line } from "@react-three/drei";
import * as THREE from "three";
import { MeshLine, MeshLineMaterial } from "three.meshline";

import styles from "./index.module.scss";
import { ThemeContext, ThemeProvider } from "../context/themeContext";
import YouTubeVideo, { VideoTexture } from "../components/youtubeVideo";

extend({ MeshLine, MeshLineMaterial });

function BoxComponent() {
  const mesh = useRef();
  const { isDarkMode } = useContext(ThemeContext);

  const edgesGeometry = new THREE.EdgesGeometry(new THREE.BoxGeometry(), 1);
  const lineSegments = new THREE.LineSegments(edgesGeometry);
  const meshLine = new MeshLine();
  meshLine.setGeometry(lineSegments.geometry);

  const edgesMaterial = useMemo(
    () =>
      new MeshLineMaterial({
        color: isDarkMode ? "white" : "black",
        lineWidth: 0.02,
      }),
    [isDarkMode]
  );

  useEffect(() => {
    edgesMaterial.color.set(isDarkMode ? "white" : "black");
    edgesMaterial.needsUpdate = true;
  }, [isDarkMode, edgesMaterial]);

  return (
    <group>
      <boxBufferGeometry ref={mesh} args={[10, 10, 10]} position={[0, 0, 0]}>
        <meshBasicMaterial
          attach="material"
          color={isDarkMode ? "white" : "black"}
        />
      </boxBufferGeometry>
      <EdgesLine
        geometry={meshLine.geometry}
        material={edgesMaterial}
        position={[0, 0, 0]}
      />
    </group>
  );
}

function EdgesLine({ geometry, material, position }) {
  return (
    <mesh position={position}>
      <bufferGeometry attach="geometry" {...geometry} />
      <meshLineMaterial attach="material" {...material} />
    </mesh>
  );
}

const Content = () => {
  const { isDarkMode, toggleTheme } = useContext(ThemeContext);

  const themeClass = isDarkMode ? styles.dark : styles.light;

  return (
    <main className={`${styles.main} ${themeClass}`}>
      <Canvas>
        <ambientLight />
        <pointLight position={[10, 10, 10]} />
        <BoxComponent />
        {/* <VideoTexture /> */}
        <OrbitControls />
      </Canvas>
      <h1 className={styles.title} onClick={toggleTheme}>
        david.mov
      </h1>
      <YouTubeVideo />
    </main>
  );
};

export default function Home() {
  return (
    <>
      <Head>
        <title>website.mov</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <ThemeProvider>
        <Content />
      </ThemeProvider>
    </>
  );
}
